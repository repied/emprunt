<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Emprunt — Mortgage Simulator</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>

<body>
    <header>
        <h1>Emprunt - Mortgage Simulator</h1>
        <p>How to choose the size of a down payment when buying a house? <br>
            This tool helps to visualize different scenarios.<br>
            It assumes that initial savings are split between the down payment and an investment account.<br>
            And that later monthly disposable cash flows will be split between mortgage repayments and
            investment contributions.
        </p>
    </header>

    <main>
        <section class="form">
            <form method="post" action="/simulate">
                <div class="common-block">
                    <div class="scenario-title">Common Parameters</div>
                    <div class="form-grid">
                        <label>Home Cost (€)
                            <input name="home_cost" type="text"
                                value="{{ '{:,.0f}'.format(result1.home_cost) if result1 else '1,050,000' }}" required>
                        </label>
                        <label>Initial Savings (€)
                            <input name="savings" type="text"
                                value="{{ '{:,.0f}'.format(result1.savings) if result1 else '1,050,000' }}" required>
                        </label>
                        <label>Mortgage Annual rate (%)
                            <input name="annual_rate" type="number" step="0.01"
                                value="{{ result1.annual_rate if result1 else 3.5 }}" required>
                        </label>
                        <label>Years
                            <input name="years" type="number" value="{{ result1.years if result1 else 20 }}" required>
                        </label>
                        <label>Investment rate (%)
                            <input name="investment_rate" type="number" step="0.1"
                                value="{{ result1.investment_rate if result1 else 5.0 }}" required>
                        </label>
                        <label>Monthly Cash flow (€)
                            <input name="monthly_cash" type="text"
                                value="{{ '{:,.0f}'.format(result1.monthly_cash) if result1 else '4,000' }}" required>
                        </label>
                    </div>
                </div>

                <div class="dual-grid" style="margin-top: 2rem;">
                    <!-- Scenario A -->
                    <div class="scenario-block">
                        <div class="scenario-title">Scenario A</div>
                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <label>Down Payment (€)
                                <input name="s1_down_payment" type="text"
                                    value="{{ '{:,.0f}'.format(result1.down_payment) if result1 else '400,000' }}"
                                    required>
                            </label>
                        </div>
                    </div>

                    <!-- Scenario B -->
                    <div class="scenario-block">
                        <div class="scenario-title">Scenario B</div>
                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <label>Down Payment (€)
                                <input name="s2_down_payment" type="text"
                                    value="{{ '{:,.0f}'.format(result2.down_payment) if result2 else '700,000' }}"
                                    required>
                            </label>
                        </div>
                    </div>
                </div>
                <button type="submit" style="width: 100%; margin-top: 2rem;">Compare Scenarios</button>
            </form>
        </section>

        {% if error %}
        <div class="error-msg"
            style="color: #ef4444; background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #fecaca; text-align: center; font-weight: 600;">
            Error: {{ error }}
        </div>
        {% endif %}

        {% if result1 and result2 and result1.schedule %}
        <section class="result">
            <h2>Scenario Comparison</h2>

            <div id="plot-container">
                <div id="comparison-plot" style="width:100%;height:500px;"></div>
            </div>

            <div class="dual-grid">
                <!-- Results Scenario A -->
                <div class="scenario-block">
                    <div class="scenario-title">Down Payment: €{{ '{:,.0f}'.format(result1.down_payment) }}</div>
                    <div class="summary-cards">
                        <div class="card">
                            <span class="label">Monthly Payment</span>
                            <span class="value">€{{ '{:,.0f}'.format(result1.payment) }}</span>
                        </div>
                        <div class="card">
                            <span class="label">Final Wealth</span>
                            <span class="value">€{{ '{:,.0f}'.format(result1.schedule[-1].combined_wealth) }}</span>
                        </div>
                    </div>
                    <div id="wealth-plot-a" style="width:100%;height:350px;"></div>
                </div>

                <!-- Results Scenario B -->
                <div class="scenario-block">
                    <div class="scenario-title">Down Payment: €{{ '{:,.0f}'.format(result2.down_payment) }}</div>
                    <div class="summary-cards">
                        <div class="card">
                            <span class="label">Monthly Payment</span>
                            <span class="value">€{{ '{:,.0f}'.format(result2.payment) }}</span>
                        </div>
                        <div class="card">
                            <span class="label">Final Wealth</span>
                            <span class="value">€{{ '{:,.0f}'.format(result2.schedule[-1].combined_wealth) }}</span>
                        </div>
                    </div>
                    <div id="wealth-plot-b" style="width:100%;height:350px;"></div>
                </div>
            </div>

            <div class="dual-grid" style="margin-top: 3rem;">
                <div class="table-container">
                    <h3>Schedule (DP €{{ "{:,.0f}".format(result1.down_payment) }})</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Equity</th>
                                <th>Invest.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in result1.schedule %}
                            {% if loop.index % (12*5) == 1 or loop.last %}
                            <tr>
                                <td>{{ row.period }}</td>
                                <td>€{{ "{:,.0f}".format(row.home_equity) }}</td>
                                <td>€{{ "{:,.0f}".format(row.investment_portfolio) }}</td>
                                <td>€{{ "{:,.0f}".format(row.combined_wealth) }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="table-container">
                    <h3>Schedule (DP €{{ "{:,.0f}".format(result2.down_payment) }})</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Equity</th>
                                <th>Invest.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in result2.schedule %}
                            {% if loop.index % (12*5) == 1 or loop.last %}
                            <tr>
                                <td>{{ row.period }}</td>
                                <td>€{{ "{:,.0f}".format(row.home_equity) }}</td>
                                <td>€{{ "{:,.0f}".format(row.investment_portfolio) }}</td>
                                <td>€{{ "{:,.0f}".format(row.combined_wealth) }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <p class="table-note" style="text-align: center;">* Showing every 5 years for brevity.</p>
        </section>

        <script>
            (function () {
                const s1 = {{ (result1.schedule if result1 and result1.schedule else[]) | tojson | safe
            }};
            const s2 = {{ (result2.schedule if result2 and result2.schedule else[]) | tojson | safe }};
            const dp1 = "€" + ({{ (result1.down_payment if result1 else 0) | tojson }}).toLocaleString();
            const dp2 = "€" + ({{ (result2.down_payment if result2 else 0) | tojson }}).toLocaleString();

            const periods = s1.map(row => row.period);

            // Combined Comparison Plot
            const traceA = {
                x: periods,
                y: s1.map(row => row.combined_wealth),
                name: 'DP ' + dp1,
                line: { color: '#4f46e5', width: 3 }
            };
            const traceB = {
                x: periods,
                y: s2.map(row => row.combined_wealth),
                name: 'DP ' + dp2,
                line: { color: '#ef4444', width: 3 }
            };

            const layoutComp = {
                title: { text: 'Combined Wealth Comparison', font: { family: 'Inter', size: 24, color: '#f8fafc' } },
                xaxis: { title: 'Months', gridcolor: 'rgba(255,255,255,0.05)', tickfont: { color: '#94a3b8' } },
                yaxis: { title: 'Wealth (€)', tickformat: '€,.0f', gridcolor: 'rgba(255,255,255,0.05)', tickfont: { color: '#94a3b8' } },
                margin: { t: 80, b: 60, l: 80, r: 40 },
                hovermode: 'x unified',
                legend: { orientation: 'h', y: -0.2, font: { color: '#f8fafc' } },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };
            Plotly.newPlot('comparison-plot', [traceA, traceB], layoutComp, { responsive: true, displayModeBar: false });

            // Individual Plots
            const createIndividualPlot = (id, data, title) => {
                const traceEquity = {
                    x: periods, y: data.map(row => row.home_equity),
                    name: 'Equity', stackgroup: 'one', line: { color: '#6366f1', width: 2 }, fillcolor: 'rgba(99, 102, 241, 0.3)'
                };
                const traceInvest = {
                    x: periods, y: data.map(row => row.investment_portfolio),
                    name: 'Invest.', stackgroup: 'one', line: { color: '#10b981', width: 2 }, fillcolor: 'rgba(16, 185, 129, 0.3)'
                };
                const layout = {
                    title: { text: title, font: { family: 'Inter', size: 16, color: '#f8fafc' } },
                    xaxis: { title: 'Months', gridcolor: 'rgba(255,255,255,0.05)', tickfont: { color: '#94a3b8' } },
                    yaxis: { title: '€', tickformat: '€,.0f', gridcolor: 'rgba(255,255,255,0.05)', tickfont: { color: '#94a3b8' } },
                    margin: { t: 40, b: 40, l: 60, r: 20 },
                    showlegend: false,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };
                Plotly.newPlot(id, [traceEquity, traceInvest], layout, { responsive: true, displayModeBar: false });
            };

            createIndividualPlot('wealth-plot-a', s1, 'Wealth: DP ' + dp1);
            createIndividualPlot('wealth-plot-b', s2, 'Wealth: DP ' + dp2);
            }) ();
        </script>
        {% endif %}
    </main>

    <footer>
        <p>&copy; 2025 Emprunt.</p>
    </footer>
</body>

</html>
